# WebP Converter API - Apache Configuration

# Disable directory listing
Options -Indexes +FollowSymLinks

# Enable RewriteEngine
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    
    # Block access to sensitive files
    RewriteRule ^config/.*$ - [F,L]
    RewriteRule ^storage/(incoming|logs)/.*$ - [F,L]
    RewriteRule ^app/.*$ - [F,L]
    RewriteRule ^\.(env|git|htaccess|htpasswd)$ - [F,L]
    RewriteRule ^(composer\.(json|lock)|package\.json)$ - [F,L]
    
    # Allow storage/output (for downloads)
    RewriteCond %{REQUEST_URI} ^/storage/output/
    RewriteRule ^.*$ - [L]
    
    # Download endpoint - route to public/download.php
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^download/(.+)$ public/download.php [QSA,L]
    
    # API endpoints - route everything to index.php
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} ^/api/
    RewriteRule ^(.*)$ index.php [QSA,L]
    
    # Health check shortcut (optional)
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^health$ index.php [QSA,L]
</IfModule>

# Block direct access to PHP files in storage
<FilesMatch "\.(log|sql|md|json|lock)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order Allow,Deny
        Deny from all
    </IfModule>
</FilesMatch>

# Security Headers
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # CORS headers (ajuste conforme necess√°rio)
    Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    Header set Access-Control-Allow-Headers "X-API-Key, Content-Type, Accept"
</IfModule>

# PHP Settings (se permitido pelo servidor)
<IfModule mod_php7.c>
    php_value upload_max_filesize 16M
    php_value post_max_size 16M
    php_value max_execution_time 300
    php_value memory_limit 256M
    php_flag display_errors Off
    php_flag log_errors On
</IfModule>

<IfModule mod_php.c>
    php_value upload_max_filesize 16M
    php_value post_max_size 16M
    php_value max_execution_time 300
    php_value memory_limit 256M
    php_flag display_errors Off
    php_flag log_errors On
</IfModule>

# Compression (if available)
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
</IfModule>

# Cache control for downloads
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/webp "access plus 1 year"
</IfModule>
