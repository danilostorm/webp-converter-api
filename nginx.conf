# WebP Converter API - Nginx Configuration
# Para usar no aaPanel:
# 1. Vá em Website > seu site > Site Directory > Site Configuration
# 2. Cole as regras abaixo DENTRO da seção "location /"
# 3. Ou adicione antes do "location / {}" principal

# ===== COPIE DAQUI =====

# Bloquear acesso a arquivos sensíveis
location ~ /\.(git|env|htaccess) {
    deny all;
    return 404;
}

location ~ ^/(config|app)/ {
    deny all;
    return 404;
}

location ~ ^/storage/(incoming|logs)/ {
    deny all;
    return 404;
}

location ~ \.(log|sql|md|json|lock)$ {
    deny all;
    return 404;
}

# Permitir acesso ao storage/output (downloads)
location ~ ^/storage/output/ {
    # Permitir acesso
}

# API Health check (endpoint direto)
location = /api/v1/health {
    try_files $uri /index.php?$query_string;
}

# Download endpoint
location ~ ^/download/(.+)$ {
    rewrite ^/download/(.+)$ /public/download.php last;
}

# API endpoints
location ~ ^/api/ {
    try_files $uri /index.php?$query_string;
}

# PHP processing
location ~ \.php$ {
    try_files $uri =404;
    fastcgi_pass unix:/tmp/php-cgi-84.sock;  # Ajuste se necessário (PHP 8.4)
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
    
    # PHP settings
    fastcgi_param PHP_VALUE "upload_max_filesize=16M \n post_max_size=16M \n max_execution_time=300 \n memory_limit=256M";
}

# Security headers
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# CORS (se necessário)
add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
add_header Access-Control-Allow-Headers "X-API-Key, Content-Type, Accept" always;

# Cache para WebP downloads
location ~* \.webp$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# ===== ATÉ AQUI =====
