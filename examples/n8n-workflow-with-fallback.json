{
  "name": "ğŸ™ï¸ Itapuranga Auto-Post PRO - WebP API Fallback",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 8,12,16,20 * * *"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [2416, 1664],
      "id": "3ce2a53a-6098-47ca-9679-bbdd3caab7b1",
      "name": "â° Schedule"
    },
    {
      "parameters": {
        "jsCode": "// ğŸ² Escolhe categoria aleatÃ³ria\nconst categorias = [\n  {query: 'polÃ­tica goiÃ¡s', cat_id: 1, nome: 'PolÃ­tica', cat_serp: '16', tags: ['polÃ­tica', 'goiÃ¡s', 'governo']},\n  {query: 'economia goiÃ¡s', cat_id: 2, nome: 'Economia', cat_serp: '784', tags: ['economia', 'goiÃ¡s', 'negÃ³cios']},\n  {query: 'esportes goiÃ¡s', cat_id: 3, nome: 'Esportes', cat_serp: '20', tags: ['esportes', 'goiÃ¡s', 'futebol']},\n  {query: 'cultura goiana', cat_id: 4, nome: 'Cultura', cat_serp: '18', tags: ['cultura', 'goiÃ¡s', 'arte']},\n  {query: 'saÃºde goiÃ¡s', cat_id: 5, nome: 'SaÃºde', cat_serp: '45', tags: ['saÃºde', 'goiÃ¡s', 'medicina']},\n  {query: 'anime brasil', cat_id: 6, nome: 'Animes', cat_serp: '8', tags: ['anime', 'brasil', 'mangÃ¡']},\n  {query: 'games brasil', cat_id: 7, nome: 'Games', cat_serp: '8', tags: ['games', 'brasil', 'jogos']}\n];\n\nconst escolhida = categorias[Math.floor(Math.random() * categorias.length)];\nconsole.log(`ğŸ¯ Categoria: ${escolhida.nome}`);\n\nreturn [{json: escolhida}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2640, 1664],
      "id": "1b7ccc09-145d-434c-bd6b-c19a97f7c8e6",
      "name": "ğŸ² Select Category"
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search.json",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {"name": "engine", "value": "google_trends"},
            {"name": "q", "value": "={{ $json.query }}"},
            {"name": "cat", "value": "={{ $json.cat_serp }}"},
            {"name": "data_type", "value": "RELATED_QUERIES"},
            {"name": "geo", "value": "BR"},
            {"name": "hl", "value": "pt-BR"},
            {"name": "date", "value": "now 7-d"},
            {"name": "api_key", "value": "YOUR_SERPAPI_KEY"}
          ]
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2848, 1664],
      "id": "2a7600a1-8673-45ba-9390-9fc3fb392fa5",
      "name": "ğŸ§  Google Trends",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const trends = $input.first()?.json;\nconst categoria = $('ğŸ² Select Category').first().json;\n\nlet temaFinal;\nif (trends && trends.related_queries) {\n  const top = trends.related_queries.top || [];\n  const candidates = top.slice(0,8).map(q=>q.query).filter(Boolean);\n  if (candidates.length > 0) {\n    const temaRaw = candidates[Math.floor(Math.random() * candidates.length)];\n    temaFinal = {tema: temaRaw, categoria: categoria.cat_id, nome: categoria.nome, tags: categoria.tags};\n  }\n}\nif (!temaFinal) {\n  temaFinal = {tema: `${categoria.query} - Guia Completo`, categoria: categoria.cat_id, nome: categoria.nome, tags: categoria.tags};\n}\nreturn [{json: temaFinal}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3072, 1664],
      "id": "bbc17be2-628b-4cec-86da-26c7e1786380",
      "name": "ğŸ¯ Extract Trends"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.groq.com/openai/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "Authorization", "value": "Bearer YOUR_GROQ_KEY"},
            {"name": "Content-Type", "value": "application/json"}
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"model\":\"llama-3.3-70b-versatile\",\"messages\":[{\"role\":\"system\",\"content\":\"VocÃª Ã© um especialista em SEO. Crie artigos otimizados retornando APENAS JSON vÃ¡lido: {\\\"title\\\": \\\"TÃ­tulo SEO\\\", \\\"meta_description\\\": \\\"DescriÃ§Ã£o\\\", \\\"focus_keyword\\\": \\\"palavra-chave\\\", \\\"content\\\": \\\"<article>HTML</article>\\\", \\\"excerpt\\\": \\\"Resumo\\\"}\"},{\"role\":\"user\",\"content\":\"Crie artigo sobre: {{ $json.tema }}\"}],\"temperature\":0.7,\"max_tokens\":4500}"
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [3296, 1664],
      "id": "701b4057-8428-47a7-9f5d-621af2a03454",
      "name": "ğŸ’¬ GROQ",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const r = $input.item.json;\nconst m = r.choices[0].message.content;\nlet a;\ntry {\n  const match = m.match(/```json\\s*([\\s\\S]*?)\\s*```/) || m.match(/({[\\s\\S]*})/);\n  a = JSON.parse(match ? match[1] : m);\n} catch(e) {\n  const tema = $('ğŸ¯ Extract Trends').item.json.tema;\n  a = {title: tema, content: m, meta_description: m.substring(0,160), focus_keyword: tema.split(':')[0].trim(), excerpt: m.substring(0,155)};\n}\nconst t = $('ğŸ¯ Extract Trends').item.json;\nconst imagePrompt = `Professional editorial photography for blog article about ${a.focus_keyword || t.tema}: clean composition, modern aesthetic, journalism style, no people, no text`;\nreturn [{json: {...a, categoria_id: t.categoria, categoria_nome: t.nome, tags: t.tags, image_prompt: imagePrompt}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3520, 1664],
      "id": "0cca94bf-d295-4d70-b2ca-1f44e653834b",
      "name": "ğŸ§¹ Parse & Clean"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/images/generations",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "Authorization", "value": "Bearer YOUR_OPENAI_KEY"},
            {"name": "Content-Type", "value": "application/json"}
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"model\":\"dall-e-3\",\"prompt\":\"{{ $json.image_prompt }}\",\"n\":1,\"size\":\"1024x1024\",\"quality\":\"standard\"}",
        "options": {"timeout": 60000}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [3744, 1664],
      "id": "85e7cfcf-0e87-4077-8922-cb3706542378",
      "name": "ğŸ¨ DALL-E 3",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const art = $('ğŸ§¹ Parse & Clean').first().json;\nconst slug = (art.title || 'image').toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').slice(0,50);\nconst imageUrl = $input.first()?.json?.data?.[0]?.url;\nif (!imageUrl) throw new Error('No image URL from DALL-E');\nreturn [{json: {imageUrl, ...art, filename: `${slug}.webp`, slug}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3968, 1664],
      "id": "4e7f8f8e-54fa-451a-adb9-6a3354358e39",
      "name": "âš™ï¸ Prep Image"
    },
    {
      "parameters": {
        "url": "={{ $json.imageUrl }}",
        "options": {"response": {"response": {"responseFormat": "file"}}}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [4192, 1664],
      "id": "7be3075f-13b1-437a-8d47-0650fcd25563",
      "name": "ğŸ“¥ Download Original"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.cloudconvert.com/v2/jobs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "Authorization", "value": "Bearer YOUR_CLOUDCONVERT_KEY"},
            {"name": "Content-Type", "value": "application/json"}
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"tasks\": {\n    \"import-image\": {\"operation\": \"import/url\", \"url\": \"{{ $('âš™ï¸ Prep Image').item.json.imageUrl }}\", \"filename\": \"input.png\"},\n    \"convert-to-webp\": {\"operation\": \"convert\", \"input\": \"import-image\", \"output_format\": \"webp\", \"quality\": 85},\n    \"export-webp\": {\"operation\": \"export/url\", \"input\": \"convert-to-webp\"}\n  }\n}"
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [4416, 1488],
      "id": "f33a4a86-f6b6-44c2-b72f-860df40e8628",
      "name": "â˜ï¸ CloudConvert Job",
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [{"leftValue": "={{ $json.data && $json.data.id }}", "rightValue": "", "operator": {"type": "string", "operation": "notEmpty"}}]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [4608, 1600],
      "id": "8fbe5f04-efbf-46b2-9d56-0f30905ccefd",
      "name": "âœ… CloudConvert OK?"
    },
    {
      "parameters": {
        "url": "=https://api.cloudconvert.com/v2/jobs/{{ $json.data.id }}/wait",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [{"name": "Authorization", "value": "Bearer YOUR_CLOUDCONVERT_KEY"}]
        },
        "options": {"timeout": 60000}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [4832, 1488],
      "id": "36333067-3570-44fd-9f7d-f83b378b378e",
      "name": "â±ï¸ CloudConvert Wait"
    },
    {
      "parameters": {
        "jsCode": "const waitResponse = $input.item.json;\nconst exportTask = waitResponse.data.tasks.find(t => t.operation === 'export/url');\nconst webpUrl = exportTask.result.files[0].url;\nconst prep = $('âš™ï¸ Prep Image').item.json;\nreturn [{json: {...prep, webpUrl, conversion_service: 'CloudConvert'}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [5056, 1488],
      "id": "bbc9f795-46d4-499a-9631-38ba67d1d731",
      "name": "ğŸ“¥ Extract CC WebP"
    },
    {
      "parameters": {
        "url": "={{ $json.webpUrl }}",
        "options": {"response": {"response": {"responseFormat": "file"}}}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [5280, 1488],
      "id": "0c4df8f4-7bbe-4a57-ae1f-e9886d89643f",
      "name": "ğŸ’¾ Download CC WebP"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.nutrient.io/build",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [{"name": "Authorization", "value": "Bearer YOUR_NUTRIENT_KEY"}]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {"name": "instructions", "value": "={\"parts\":[{\"file\":\"document\"}],\"output\":{\"type\":\"image\",\"format\":\"webp\",\"width\":1280}}"},
            {"parameterType": "formBinaryData", "name": "document", "inputDataFieldName": "data"}
          ]
        },
        "options": {"response": {"response": {"responseFormat": "file"}}}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [4832, 1696],
      "id": "03c96cc0-a30f-45c0-adf0-3a414c40c444",
      "name": "ğŸ¥— Nutrient Convert",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const prep = $('âš™ï¸ Prep Image').item.json;\nreturn [{json: {...prep, conversion_service: 'Nutrient'}, binary: $input.item.binary}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [5056, 1696],
      "id": "23f20e9d-221e-488d-8db4-a154596a8208",
      "name": "ğŸ“¦ Prepare Nutrient"
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [{"leftValue": "={{ $json.binary && $json.binary.data }}", "rightValue": "", "operator": {"type": "string", "operation": "notEmpty"}}]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [5280, 1808],
      "id": "nutrient-check",
      "name": "âœ… Nutrient OK?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://img.hoststorm.cloud/api/v1/convert",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "X-API-Key", "value": "wca_ce5db7f2bda0c3545ef54d2777a813b463f5a0442460d75544244cee656d37d9"},
            {"name": "Content-Type", "value": "application/json"}
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"source_url\": \"{{ $('âš™ï¸ Prep Image').item.json.imageUrl }}\", \"quality\": 85, \"width\": 1280}",
        "options": {"timeout": 60000}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [5056, 1904],
      "id": "webp-api-convert",
      "name": "ğŸš€ WebP API (Fallback)",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const apiResp = $input.item.json;\nif (!apiResp.result_url) throw new Error('WebP API falhou');\nconst prep = $('âš™ï¸ Prep Image').item.json;\nreturn [{json: {...prep, webpUrl: apiResp.result_url, conversion_service: 'WebP-API'}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [5280, 1904],
      "id": "webp-api-parse",
      "name": "ğŸ“¥ Parse WebP API"
    },
    {
      "parameters": {
        "url": "={{ $json.webpUrl }}",
        "options": {"response": {"response": {"responseFormat": "file"}}}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [5504, 1904],
      "id": "webp-api-download",
      "name": "ğŸ’¾ Download WebP API"
    },
    {
      "parameters": {
        "jsCode": "let finalData = null;\nlet finalBinary = null;\n\n// Try CloudConvert\ntry {\n  const cc = $('ğŸ’¾ Download CC WebP').first();\n  if (cc && cc.binary) {\n    finalData = $('ğŸ“¥ Extract CC WebP').first().json;\n    finalBinary = cc.binary;\n    console.log('âœ… CloudConvert');\n  }\n} catch(e) {}\n\n// Try Nutrient\nif (!finalData) {\n  try {\n    const nt = $('ğŸ“¦ Prepare Nutrient').first();\n    if (nt && nt.binary) {\n      finalData = nt.json;\n      finalBinary = nt.binary;\n      console.log('âœ… Nutrient (Fallback 1)');\n    }\n  } catch(e) {}\n}\n\n// Try WebP API\nif (!finalData) {\n  try {\n    const api = $('ğŸ’¾ Download WebP API').first();\n    if (api && api.binary) {\n      finalData = $('ğŸ“¥ Parse WebP API').first().json;\n      finalBinary = api.binary;\n      console.log('âœ… WebP API (Fallback 2)');\n    }\n  } catch(e) {}\n}\n\nif (!finalData) throw new Error('âŒ Todas conversÃµes falharam!');\n\nreturn [{json: finalData, binary: finalBinary}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [5712, 1664],
      "id": "b7d3a0eb-d227-4737-a1d9-7bb8fe9438e4",
      "name": "ğŸ”— Merge All Conversions"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://itapuranga.com.br/api/upload-image.php",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [{"name": "Authorization", "value": "Bearer YOUR_API_TOKEN"}]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {"name": "filename", "value": "={{ $json.filename }}"},
            {"parameterType": "formBinaryData", "name": "image", "inputDataFieldName": "data"}
          ]
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [5936, 1664],
      "id": "6c3c5062-9385-4512-b107-ce9f5ba85ebf",
      "name": "ğŸ’¾ Upload to WordPress"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://itapuranga.com.br/api/posts.php",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "Authorization", "value": "Bearer YOUR_API_TOKEN"},
            {"name": "Content-Type", "value": "application/json"}
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "title", "value": "={{ $('ğŸ”— Merge All Conversions').item.json.title }}"},
            {"name": "category_id", "value": "={{ $('ğŸ² Select Category').item.json.cat_id }}"},
            {"name": "content", "value": "={{ $('ğŸ”— Merge All Conversions').item.json.content }}"},
            {"name": "image_url", "value": "={{ $('ğŸ’¾ Upload to WordPress').item.json.url }}"},
            {"name": "status", "value": "published"}
          ]
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [6160, 1664],
      "id": "29fec8af-f262-4430-9529-583c68036a4e",
      "name": "ğŸš€ Publish Post"
    },
    {
      "parameters": {
        "jsCode": "const resp = $input.item.json;\nconst merge = $('ğŸ”— Merge All Conversions').item.json;\nconsole.log('ğŸ‰ POST PUBLICADO!');\nconsole.log('TÃ­tulo:', resp.data?.title);\nconsole.log('ConversÃ£o:', merge.conversion_service);\nconsole.log('URL:', resp.data?.url);\nreturn [{json: {success: true, post_id: resp.data?.id, post_url: resp.data?.url, conversion_method: merge.conversion_service}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [6384, 1664],
      "id": "b05e8e27-31a0-430e-8e68-4085bfcc1390",
      "name": "ğŸ‰ Success"
    }
  ],
  "connections": {
    "â° Schedule": {"main": [[{"node": "ğŸ² Select Category", "type": "main", "index": 0}]]},
    "ğŸ² Select Category": {"main": [[{"node": "ğŸ§  Google Trends", "type": "main", "index": 0}]]},
    "ğŸ§  Google Trends": {"main": [[{"node": "ğŸ¯ Extract Trends", "type": "main", "index": 0}]]},
    "ğŸ¯ Extract Trends": {"main": [[{"node": "ğŸ’¬ GROQ", "type": "main", "index": 0}]]},
    "ğŸ’¬ GROQ": {"main": [[{"node": "ğŸ§¹ Parse & Clean", "type": "main", "index": 0}]]},
    "ğŸ§¹ Parse & Clean": {"main": [[{"node": "ğŸ¨ DALL-E 3", "type": "main", "index": 0}]]},
    "ğŸ¨ DALL-E 3": {"main": [[{"node": "âš™ï¸ Prep Image", "type": "main", "index": 0}]]},
    "âš™ï¸ Prep Image": {"main": [[{"node": "ğŸ“¥ Download Original", "type": "main", "index": 0}]]},
    "ğŸ“¥ Download Original": {"main": [[{"node": "â˜ï¸ CloudConvert Job", "type": "main", "index": 0}]]},
    "â˜ï¸ CloudConvert Job": {"main": [[{"node": "âœ… CloudConvert OK?", "type": "main", "index": 0}]]},
    "âœ… CloudConvert OK?": {"main": [[{"node": "â±ï¸ CloudConvert Wait", "type": "main", "index": 0}], [{"node": "ğŸ¥— Nutrient Convert", "type": "main", "index": 0}]]},
    "â±ï¸ CloudConvert Wait": {"main": [[{"node": "ğŸ“¥ Extract CC WebP", "type": "main", "index": 0}]]},
    "ğŸ“¥ Extract CC WebP": {"main": [[{"node": "ğŸ’¾ Download CC WebP", "type": "main", "index": 0}]]},
    "ğŸ’¾ Download CC WebP": {"main": [[{"node": "ğŸ”— Merge All Conversions", "type": "main", "index": 0}]]},
    "ğŸ¥— Nutrient Convert": {"main": [[{"node": "ğŸ“¦ Prepare Nutrient", "type": "main", "index": 0}]]},
    "ğŸ“¦ Prepare Nutrient": {"main": [[{"node": "âœ… Nutrient OK?", "type": "main", "index": 0}]]},
    "âœ… Nutrient OK?": {"main": [[{"node": "ğŸ”— Merge All Conversions", "type": "main", "index": 0}], [{"node": "ğŸš€ WebP API (Fallback)", "type": "main", "index": 0}]]},
    "ğŸš€ WebP API (Fallback)": {"main": [[{"node": "ğŸ“¥ Parse WebP API", "type": "main", "index": 0}]]},
    "ğŸ“¥ Parse WebP API": {"main": [[{"node": "ğŸ’¾ Download WebP API", "type": "main", "index": 0}]]},
    "ğŸ’¾ Download WebP API": {"main": [[{"node": "ğŸ”— Merge All Conversions", "type": "main", "index": 0}]]},
    "ğŸ”— Merge All Conversions": {"main": [[{"node": "ğŸ’¾ Upload to WordPress", "type": "main", "index": 0}]]},
    "ğŸ’¾ Upload to WordPress": {"main": [[{"node": "ğŸš€ Publish Post", "type": "main", "index": 0}]]},
    "ğŸš€ Publish Post": {"main": [[{"node": "ğŸ‰ Success", "type": "main", "index": 0}]]}
  }
}
